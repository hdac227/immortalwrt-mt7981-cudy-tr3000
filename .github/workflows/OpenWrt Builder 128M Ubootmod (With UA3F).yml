name: OpenWrt Builder 128M Ubootmod (With UA3F)

on:
  workflow_dispatch:

env:
  CCACHE_DIR: /workdir/.ccache
  CCACHE_MAXSIZE: 6G
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
  REPO_BRANCH: openwrt-24.10-6.6
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ™Œ Checkout
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Init Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses-dev libpython3-dev libreadline-dev libssl-dev libtool libyaml-dev libz-dev lld llvm lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: ðŸªœ Clone Source
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: âž• Add UA3F Source
        run: |
          cd openwrt
          # å…‹éš† UA3F æºç åˆ° package ç›®å½•ï¼Œè¿™æ · make menuconfig å°±èƒ½çœ‹åˆ°å®ƒ
          git clone https://github.com/SunBK201/UA3F.git package/ua3f

      - name: ðŸ§¬ Update & Install Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ðŸ§© Load Configuration & Fix Dependencies
        run: |
          cd openwrt
          # å¦‚æžœä½ æœ‰è‡ªå®šä¹‰ config æ–‡ä»¶ï¼Œè¯·å–æ¶ˆä¸‹é¢æ³¨é‡Šå¹¶ä¸Šä¼ 
          # mv $GITHUB_WORKSPACE/config/128muboot.config .config
          
          # å¦‚æžœæ²¡æœ‰è‡ªå®šä¹‰ configï¼Œè¿™é‡Œç”Ÿæˆé»˜è®¤é…ç½® (é’ˆå¯¹ MT798x)
          # æ³¨æ„ï¼šä½ éœ€è¦ç¡®è®¤ä½ çš„å…·ä½“è®¾å¤‡åž‹å·ï¼Œè¿™é‡Œå‡è®¾æ˜¯é»˜è®¤ targetï¼Œå¦‚æžœä¸æ˜¯ï¼Œè¯·å…ˆåŠ è½½ä½ çš„ config
          # ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œå‡è®¾ä½ å·²ç»æœ‰äº†ä¸€ä¸ª .config æˆ–è€…ä½¿ç”¨é»˜è®¤
          [ -e files ] && mv files openwrt/files

          echo "ðŸ”§ Modifying .config..."
          
          # 1. ç¦ç”¨ ebtables (è§£å†³ç¼–è¯‘æŠ¥é”™)
          sed -i '/CONFIG_PACKAGE_ebtables/d' .config
          sed -i '/CONFIG_PACKAGE_kmod-ebtables/d' .config
          echo "# CONFIG_PACKAGE_ebtables is not set" >> .config
          echo "# CONFIG_PACKAGE_ebtables-nft is not set" >> .config
          echo "# CONFIG_PACKAGE_ebtables-utils is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-ebtables is not set" >> .config

          # 2. ç›´æŽ¥å¯ç”¨ UA3F (ç¼–è¯‘è¿›å›ºä»¶)
          # è¿™ä¼šè‡ªåŠ¨è§¦å‘ kmod-nft-queue å’Œ kmod-nft-tproxy çš„é€‰ä¸­
          sed -i '/CONFIG_PACKAGE_ua3f/d' .config
          echo "CONFIG_PACKAGE_ua3f=y" >> .config
          
          # 3. å¼ºåˆ¶é€‰ä¸­ä¾èµ–æ¨¡å— (ä½œä¸ºåŒé‡ä¿é™©ï¼Œè®¾ä¸º =y)
          echo "CONFIG_PACKAGE_kmod-nft-queue=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nft-tproxy=y" >> .config
          echo "CONFIG_PACKAGE_kmod-nfnetlink-queue=y" >> .config

          # 4. è®© OpenWrt è‡ªåŠ¨è®¡ç®—å¹¶ä¿®å¤å‰©ä½™ä¾èµ–
          make defconfig

      - name: ðŸ“ Check Config
        run: |
          cd openwrt
          echo "ðŸ” Checking if UA3F is enabled:"
          grep -i "ua3f" .config
          echo "ðŸ” Checking if kmod-nft-queue is enabled:"
          grep -i "nft-queue" .config

      - name: ðŸ•¹ï¸ Download Packages
        run: |
          cd openwrt
          make download -j$(nproc)

      - name: ðŸ”® Compile Firmware
        id: compile
        run: |
          cd openwrt
          echo "ðŸ”¨ Compiling..."
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          
          # æå–è®¾å¤‡åå’Œæ—¶é—´
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: âŒš Organize Files
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: ðŸ“¤ Upload Firmware
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success'
        with:
          name: OpenWrt_UA3F_Integrated_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}
